#!/usr/bin/env bash
set -euo pipefail

# Extract slug/path from VNCP_PROXIES if port 8080 is present
slug_path="/"
if command -v jq >/dev/null 2>&1 && [[ -n "${VNCP_PROXIES:-}" ]]; then
  entry="$(printf '%s' "$VNCP_PROXIES" | jq -r '[.[] | select(.port == 8080)][0] // empty')" || true
  if [[ -n "$entry" && "$entry" != "null" ]]; then
    p="$(printf '%s' "$entry" | jq -r '.path // empty' || true)"
    s="$(printf '%s' "$entry" | jq -r '.slug // empty' || true)"
    if [[ -n "$p" && "$p" != "null" ]]; then slug_path="$p"; elif [[ -n "$s" ]]; then slug_path="/$s"; fi
  fi
fi

# Normalize
slug_path="${slug_path%/}"
[[ "$slug_path" == "" ]] && slug_path="/"

# Try HTTP and HTTPS
urls=(
  "http://127.0.0.1:${OPENHAB_HTTP_PORT:-8080}${slug_path}/"
  "https://127.0.0.1:${OPENHAB_HTTPS_PORT:-8443}${slug_path}/"
)

for url in "${urls[@]}"; do
  if curl -skI --connect-timeout 2 --max-time 4 "$url" | grep -qE "HTTP/.* (2..|3..|401|403)"; then
    echo "[vncp-healthcheck] OK: $url"
    exit 0
  fi
done

echo "[vncp-healthcheck] FAIL: none of ${urls[*]} responded correctly" >&2
exit 1

#!/usr/bin/env sh
set -eu

INFO_DIR="${VNCP_INFO_DIR:-/vncp}"
TMP="${INFO_DIR%/}/.vncp-info.json.tmp"
OUT="${INFO_DIR%/}/vncp-info.json"

CN_NAME="${VNCP_NAME:-$(cat /etc/hostname 2>/dev/null || echo vncp-openhab)}"
HTTP_PORT="${OPENHAB_HTTP_PORT:-8080}"
HTTPS_PORT="${OPENHAB_HTTPS_PORT:-8443}"
BASE="${VNCP_PUBLIC_BASE:-}"

http_url() {
  if [ -n "$BASE" ]; then printf "%s:%s" "$BASE" "$1"; else printf "http://localhost:%s" "$1"; fi
}

umask 022
mkdir -p "${INFO_DIR%/}"
cat >"$TMP" <<EOF
{
  "name": "${CN_NAME}",
  "dashboards": [
    { "name": "HABPanel", "url": "$(http_url "$HTTP_PORT")" }
  ],
  "meta": {
    "image": "openhab/openhab:latest",
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  }
}
EOF
mv -f "$TMP" "$OUT"
chmod 0644 "$OUT"

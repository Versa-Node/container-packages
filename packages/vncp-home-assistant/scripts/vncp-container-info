#!/usr/bin/env sh
set -eu

INFO_DIR="${VNCP_INFO_DIR:-/vncp}"
TMP="${INFO_DIR%/}/.vncp-info.json.tmp"
OUT="${INFO_DIR%/}/vncp-info.json"

CN_NAME="${VNCP_NAME:-$(cat /etc/hostname 2>/dev/null || echo vncp-home-assistant)}"
HTTP_PORT="${HASS_HTTP_PORT:-8123}"

http_url() {
  printf "http://localhost:%s" "$1"
}

umask 022
mkdir -p "${INFO_DIR%/}"
cat >"$TMP" <<EOF
{
  "name": "${CN_NAME}",
  "dashboards": [
    { "name": "Home Assistant", "url": "$(http_url "$HTTP_PORT")" }
  ],
  "meta": {
    "image": "homeassistant/home-assistant:stable",
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  }
}
EOF
mv -f "$TMP" "$OUT"
chmod 0644 "$OUT"

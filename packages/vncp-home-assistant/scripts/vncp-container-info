#!/usr/bin/env sh
set -eu

INFO_DIR="${VNCP_INFO_DIR:-/vncp}"
TMP="${INFO_DIR%/}/.vncp-info.json.tmp"
OUT="${INFO_DIR%/}/vncp-info.json"

CN_NAME="${VNCP_NAME:-$(cat /etc/hostname 2>/dev/null || echo vncp-home-assistant)}"
HTTP_PORT="${HASS_HTTP_PORT:-8123}"
BASE="${VNCP_PUBLIC_BASE:-}"

http_url() {
  # If VNCP_PUBLIC_BASE is set (e.g. http://myhost or https://ha.example.com),
  # append the internal port. Otherwise keep a <hostname> placeholder for the UI to replace.
  if [ -n "$BASE" ]; then
    printf "%s:%s" "$BASE" "$1"
  else
    printf "http://<hostname>:%s" "$1"
  fi
}

umask 022
mkdir -p "${INFO_DIR%/}"
cat >"$TMP" <<EOF
{
  "name": "${CN_NAME}",
  "dashboards": [
    { "name": "Home Assistant", "url": "$(http_url "$HTTP_PORT")" }
  ],
  "meta": {
    "image": "homeassistant/home-assistant:stable",
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  }
}
EOF
mv -f "$TMP" "$OUT"
chmod 0644 "$OUT"
